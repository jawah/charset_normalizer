name: Continuous Integration

on:
  workflow_call:
  pull_request:
  push:
    branches:
      - master

permissions:
  contents: read

jobs:
  lint:
    name: üé® Linters
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3'
      - name: Install nox
        run: python -m pip install nox
      - name: Pre-commit checks
        run: nox -s lint

  tests:
    name: ‚úÖ Tests
    runs-on: ubuntu-22.04

    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.7"
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
      - name: Install dependencies
        run: python -m pip install nox
      - name: Run tests
        run: nox -s test-${{ matrix.python-version }}
      - name: "Upload artifact"
        uses: "actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce"
        with:
          name: coverage-data
          path: ".coverage.*"
          if-no-files-found: error

  detection_coverage:

    needs:
      - tests

    name: üìà Detection Coverage
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3'
      - name: Install dependencies
        run: python -m pip install nox
      - name: Coverage WITH preemptive
        run: nox -s coverage -- --coverage 97 --with-preemptive
      - name: Coverage WITHOUT preemptive
        run: nox -s coverage -- --coverage 95
      - name: "Upload artifact"
        uses: "actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce"
        with:
          name: coverage-data
          path: ".coverage.*"
          if-no-files-found: error

  integration_test:

    needs:
      - tests

    name: üîó Integration Tests
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        downstream_project:
          - niquests
          - requests

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3'
      - name: Install dependencies
        run: pip install nox
      - name: Integration Tests with Requests
        run: nox -s downstream_${{ matrix.downstream_project }}

  chardet_bc:

    name: ‚è™ Chardet Backward-Compatibility Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3'
      - name: Install dependencies
        run: pip install nox
      - name: BC Coverage
        run: nox -s backward_compatibility -- --coverage 80

  mypyc_test:

    name: ‚ö° MypyC Tests

    needs:
      - tests

    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
        os: [ ubuntu-latest, macos-latest, windows-latest ]
        include:
          - python-version: "3.7"
            os: ubuntu-22.04
          - python-version: "3.7"
            os: macos-13
          - python-version: "3.7"
            os: windows-latest
    env:
      PYTHONIOENCODING: utf8  # only needed for Windows (console IO output encoding)
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
      - name: Install nox
        run: pip install nox
      - name: Run tests with mypyc enabled
        run: nox -s test_mypyc-${{ matrix.python-version }}
      - name: "Upload artifact"
        uses: "actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce"
        with:
          name: coverage-data
          path: ".coverage.*"
          if-no-files-found: error

  coverage:
    if: always()
    runs-on: "ubuntu-latest"
    needs:
      - tests
      - mypyc_test
      - detection_coverage
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@d632683dd7b4114ad314bca15554477dd762a938"

      - name: "Setup Python"
        uses: "actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b"
        with:
          python-version: "3.x"

      - name: "Install coverage"
        run: "python -m pip install --upgrade coverage"

      - name: "Download artifact"
        uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a
        with:
          name: coverage-data

      - name: "Combine & check coverage"
        run: |
          python -m coverage combine
          python -m coverage html --skip-covered --skip-empty
          python -m coverage report --ignore-errors --show-missing --fail-under=92

      - name: "Upload report"
        uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce
        with:
          name: coverage-report
          path: htmlcov

  performance:
    name: ‚ö° Performance Test
    runs-on: ubuntu-latest

    needs: coverage

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3'
      - name: Install dependencies
        run: pip install nox
      - name: Performance Measurement
        run: nox -s performance
